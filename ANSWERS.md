# 25. Спекуляция. Спекулятивный суперскалярный процессор. Основные этапы исполнения инструкций
**Спекуляция** — выполнение некоторой операция, необходимость выполнения которой носит вероятностный характер.

ССП способен выполнять инструкции, которые следуют за невыполненной инструкцией условного перехода, основываясь на данных предсказателя ветвления, и в случае неверного предсказания выполнять откат.

Этапы исполнения инструкции ССП
1. Выборка инструкции
2. Планирование инструкции
3. Ожидание готовности операндов
4. Исполнение
5. Запись результата
6. Завершение (commit)

**Дальше под вопросом потому что хз надо это или нет**

Стадии записи результата и завершения
1. Стадия записи результата:
    - результат работы инструкции помещается в промежуточное хранилище, а не восновной регистровый файл
2. Стадия завершения:
    - проверка корректности исполнения инструкции
    - генерируются исключения, если необходимо
    - записывается результат из временного хранилища в основной регистровый файл

Изменения в аппаратной схеме
1. добавлен: буфер упорядочивания (reorder buffer)
    - используется для:
        - хранение результатов работы инструкций между стадией записи результата и стадией завершения
        - поддержка программного порядка инструкция на стадии завершения
    - элемент БУ содержит:
        - выполняемую инструкцию: арифметическая, загрузка, сохранение, условный переход
        - адрес результата инструкции
        - поля для временного хранения результата инструкции
1. удален: буфер сохранения

Этап планирования
- планирование инструкций осуществляется с вершины очереди инструкций
- для выполнения планирования должны быть доступна СР на требуемом ФУ и
ячейка на БУ, если хотя бы один из ресурсов не доступен, инструкция ожидает в
очереди
- выборка операндов состоит из трех стадий:
    - проверяются есть ли данные в регистровом файле, если есть переписываются в СР, если нет, то
    - проверяются, есть ли данные в БУ, если есть – переписываются в СР, если нет, то
    - в СР записывается номер ячейки БУ, которая содержит инструкцию, которая
вычислит этот операнд
- в файл переименования для результирующего регистра инструкции
помещается номер ячейки БУ, которая ее содержит

Этап исполнения и записи результата
- инструкции запускаются на исполнении по мере готовности их операндов и
доступности ФУ
- по общей шине передается результат инструкции и номер ячейки БУ, которая ее
содержит
- запись результата выполняется одновременно во все ожидающие СР и БУ
- инструкция загрузки выполняется в две стадии:
    - вычисление адреса
    - чтение из памяти. Запускается, если нет конфликтов с предыдущими
инструкциями загрузки и сохранения
- инструкция сохранения на этапе исполнения вычисляет адрес операнда и
ожидает готовности результата, запись в память произойдет на стадии
завершения

Этап завершения
- инструкция после вычисления результата ожидает в БУ своего завершения
- завершаются инструкции, которые находятся на вершину БУ. БУ поддерживает поведение очереди FIFO
- на этапе завершения:
    - для арифметических инструкции и инструкции загрузки проверяется наличие
исключений и если исключений нет, результат записывается в регистровый файл
    - для инструкции сохранения проверяется наличие исключений и если исключений нет, результат записывается в память
    = для инструкции условного перехода проверяется правильно она была
предсказана или нет, если да, инструкция удаляется из БУ, если нет, происходит сброс процессора: очищаются все стадии, на планирование отправляется первая инструкция из правильной ветви
# 26. Алгоритм Томасуло. Планирование инструкций
**Состав процессора(для удобства, но по идее не надо)**
- Очередь планирования (Instruction queue)[ОП] 
- Регистровый файл (FP Registers) [РФ]
- Станции резервирования (Reserve Station) [СР]
- Простое вещественное устройство (FP adder)
- Сложное вещественное устройство (FP Muliplier)
- Общая шина данных (Common Data Bus)[ОШД]
- Устройство вычисление адреса (Address Unit)
- Буфера загрузки (Load buffer)
- Буфера сохранения (Store buffer)
- Устройство работы с памятью (Memory Unit).

**Алгоритм Томасуло** — Это алгоритм динамического планирования инструкций, 
который позволяет исполнять инструкции в порядке отличном от программного.

- При одновременном исполнении двух и более инструкций позволяет разрешить
RAW, и устранить WAR и WAW конфликты
- Разрешение конфликтов RAW происходит за счет запуска инструкции, только когда
готовы ее операнды.
-  Устранение WAR и WAW конфликтов происходит за счет переименования регистров
с использованием станций резервирования (Reserve Station).
- RS используются для хранения операндов инструкции и воссоздания графа
зависимостей по данным между инструкциями, которые находятся в исполнении.

1. Выборка с вершины ОП.
    - Выборка происходит по 1 инструкции за такт.
    - Выборка осуществляется в программном порядке, так как очередь FIFO
1. Декодирование.
1. Назначение на исполнительное устройство.
    - Если все СР устройства заняты, то инструкция возвращается в ОП и
 ожидает освобождения RS.
1. Выборка операндов.

Если операнды вычислены, то они выбираются из РФ, если нет, то в дескрипторах СР
устанавливается ссылки на другие СР.

**Ожидание готовности операндов, исполнение, сохранение результатов**
- Инструкция ожидает в СР до тех пор, пока не будут вычислены все ее операнды и
 записаны в соответствующие дескрипторы.
- Передача вычисленного операнда происходит по ОШД вместе с номером СР, который его
 содержал
- Каждая СР слушает ОШД и сравнивает значение номер передаваемого по ней СР с
 ожидаемым. Если номера совпадает то она забирает значение операнда с ОШД
- Передаваемые по ОШД данные сохраняются в РФ.
- Если все операнды находятся СР, то инструкция отправляется на исполнение.

**Обработка инструкций загрузки и сохранения**
- Инструкция загрузки:
    - Вычисление адреса
    - Выполнение загрузки по адресу
- Инструкция сохранения:
    - Вычисление адреса
    - Ожидания готовности операнда
    - Выполнение сохранения по адресу.
- Буфер загрузки: поле адреса
- Буфер сохранения: поле адреса, СР для операнда


# 27. Алгоритм Томасуло. Состав процессора. Этапы исполнения инструкций
**Алгоритм Томасуло** — Это алгоритм динамического планирования инструкций, 
который позволяет исполнять инструкции в порядке отличном от программного.

- При одновременном исполнении двух и более инструкций позволяет разрешить
RAW, и устранить WAR и WAW конфликты
- Разрешение конфликтов RAW происходит за счет запуска инструкции, только когда
готовы ее операнды.
-  Устранение WAR и WAW конфликтов происходит за счет переименования регистров
с использованием станций резервирования (Reserve Station).
- RS используются для хранения операндов инструкции и воссоздания графа
зависимостей по данным между инструкциями, которые находятся в исполнении.

**Состав процессора**
- Очередь планирования (Instruction queue)[ОП] 
- Регистровый файл (FP Registers) [РФ]
- Станции резервирования (Reserve Station) [СР]
- Простое вещественное устройство (FP adder)
- Сложное вещественное устройство (FP Muliplier)
- Общая шина данных (Common Data Bus)[ОШД]
- Устройство вычисление адреса (Address Unit)
- Буфера загрузки (Load buffer)
- Буфера сохранения (Store buffer)
- Устройство работы с памятью (Memory Unit).

**Этапы исполнения инструкции**

Классический конвейер
- Выборка инструкции
- Выборка операндов
- Исполнение
- Сохранение результата

Алгоритм Тамасуло
- Выборка инструкции
- Планирование инструкции
- Ожидание готовности операндов
- Исполнение
- Сохранение результата
# 28. Спекулятивный суперскалярный процессор
**черт знает что он хочет**
ССП способен выполнять инструкции, которые следуют за невыполненной инструкцией условного перехода, основываясь на данных предсказателя ветвления, и в случае неверного предсказания выполнять откат. 

**Информация дальше просто есть, не знаю, куда ее пристроить**

Стадии записи результата и завершения
1. Стадия записи результата:
    - результат работы инструкции помещается в промежуточное хранилище, а не восновной регистровый файл
2. Стадия завершения:
    - проверка корректности исполнения инструкции
    - генерируются исключения, если необходимо
    - записывается результат из временного хранилища в основной регистровый файл

Изменения в аппаратной схеме
1. добавлен: буфер упорядочивания (reorder buffer)
    - используется для:
        - хранение результатов работы инструкций между стадией записи результата и стадией завершения
        - поддержка программного порядка инструкция на стадии завершения
    - элемент БУ содержит:
        - выполняемую инструкцию: арифметическая, загрузка, сохранение, условный переход
        - адрес результата инструкции
        - поля для временного хранения результата инструкции
1. удален: буфер сохранения

Этап планирования
- планирование инструкций осуществляется с вершины очереди инструкций
- для выполнения планирования должны быть доступна СР на требуемом ФУ и
ячейка на БУ, если хотя бы один из ресурсов не доступен, инструкция ожидает в
очереди
- выборка операндов состоит из трех стадий:
    - проверяются есть ли данные в регистровом файле, если есть переписываются в СР, если нет, то
    - проверяются, есть ли данные в БУ, если есть – переписываются в СР, если нет, то
    - в СР записывается номер ячейки БУ, которая содержит инструкцию, которая
вычислит этот операнд
- в файл переименования для результирующего регистра инструкции
помещается номер ячейки БУ, которая ее содержит

Этап исполнения и записи результата
- инструкции запускаются на исполнении по мере готовности их операндов и
доступности ФУ
- по общей шине передается результат инструкции и номер ячейки БУ, которая ее
содержит
- запись результата выполняется одновременно во все ожидающие СР и БУ
- инструкция загрузки выполняется в две стадии:
    - вычисление адреса
    - чтение из памяти. Запускается, если нет конфликтов с предыдущими
инструкциями загрузки и сохранения
- инструкция сохранения на этапе исполнения вычисляет адрес операнда и
ожидает готовности результата, запись в память произойдет на стадии
завершения

Этап завершения
- инструкция после вычисления результата ожидает в БУ своего завершения
- завершаются инструкции, которые находятся на вершину БУ. БУ поддерживает поведение очереди FIFO
- на этапе завершения:
    - для арифметических инструкции и инструкции загрузки проверяется наличие
исключений и если исключений нет, результат записывается в регистровый файл
    - для инструкции сохранения проверяется наличие исключений и если исключений нет, результат записывается в память
    = для инструкции условного перехода проверяется правильно она была
предсказана или нет, если да, инструкция удаляется из БУ, если нет, происходит сброс процессора: очищаются все стадии, на планирование отправляется первая инструкция из правильной ветви

# 29. EPIC. Механизмы поддержки спекуляции
**EPIC (explicit parallel instruction set)** — Архитектура с явным параллелизмом на уровне инструкций. 
- Призвана сохранить достоинства VLIW архитектуры и устранить ее
 недостатки
- Достоинства VLIW и EPIC: возможность параллельного исполнения
 инструкций задается на уровне архитектуры, а не определяется динамически в
 процессе исполнения
-  Недостаток VLIW устраненный EPIC: решена проблема бинарной
 совместимости между различными процессорами

**Спекуляция по данным**
- Компилятор переносит инструкцию настолько вверх, насколько нужно, не
 обращая внимание на возможные конфликты.
- Перед инструкцией потребителем данных вставляется специальная
 инструкция проверки, которая проверяет были ли сохранения по целевому
 адресу после запуска инструкции загрузки.
- Если произошел конфликт, то инструкция проверки может сгенерировать
 исключение или выполнить обычную загрузку.

**Спекуляция по управлению в EPIC основано на:**
- Наличие двух типов инструкций: спекулятивных и неспекулятивных
- Параллельном исполнении спекулятивных инструкций из двух ветвей
- Использование предикатирования для выбора результата корректной
ветви.
- Использование третьего состояния регистров для сохранения
поведения исключений во время спекуляции.
# 30. EPIC. Пакет инструкций – способ явного задания параллелизма уровня команд
**Пакет инструкций (тоже хз, что-то мало в лекциях)**
- Состоит из слотов инструкций и шаблона
- Шаблон определяет:
    - Тип инструкций в слотах
    - Расположения разделителя последовательности инструкций
- Инструкции в последовательности является независимыми и запускаются
процессором в произвольном порядке по мере готовности устройств.
- После запуска всех инструкций из последовательности процессор переходи к
обработке следующей последовательности
-  Запуск инструкций из последовательности начинается, когда конфликты для всех инструкций разрешены.

EPIC предполагает выявление параллелизма уровня ILP(Instruction-Level Parallelism) программным путём (уровень компилятора) и формирование VLIW из независимых по данным машинных команд (обеспечивая т.о. параллелизм их выполнения)
# 52. Микроархитектуры Intel Haswell и Broadwell
# 53. Микроархитектуры Intel Skylake и его наследники
# 54. Микроархитектура Intel Alder Lake
# 55. Микроархитектура AMD Zen
# 56. Микроархитектура AMD Zen 2 и наследников

# 71. Микроархитектура NVIDIA Turing
# 72. Микроархитектура NVIDIA Ampere
# 73. Микроархитектура NVIDIA Hopper
# 74. Микроархитектура NVIDIA Ada Lovelace
# 75. Микроархитектура NVIDIA Volta